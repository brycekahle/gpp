<html>
<head>
<link rel="stylesheet" type="text/css" href="style.css" />
<body>
  <script src="jquery-1.7.min.js"></script>
  <script src="Three.js"></script>
  <script src="RequestAnimationFrame.js"></script>
  <script src="Stats.js"></script>
  
  <script src="physics.js"></script>
  <script type="text/javascript">
    var camera, scene, renderer, paddle, 
    mousex = 0.5, mousey = 0.5, mousexoffset = 0, mouseyoffset = 0,
    stats, container, accelStats, ball;
   
    var WINDOWWIDTH = window.innerWidth,
    WINDOWHEIGHT = window.innerHeight;

	// Set colors
	var roomColors = {
		top: 0x999999,
		bottom: 0xdddddd,
		left: 0xbbbbbb,
		right: 0xaaaaaa,
		back: 0xcccccc
	}

    // set the scene size
    var WIDTH = WINDOWWIDTH,
    HEIGHT = WINDOWHEIGHT;

// set some camera attributes
    var VIEW_ANGLE = 45,
    ASPECT = WIDTH / HEIGHT,
    NEAR = 0.1,
    FAR = 40000;
    
    var PI = 3.141596;
    var MOVEFACTOR = 0.1, MOTIONFACTOR = 0.05;
    
    var BOXDEPTH = 32 * HEIGHT, 
        BOXHEIGHT = 4 * HEIGHT;
    
    var ballSize = WIDTH / 4;

    init();
    animate();

    function init() {
        container = document.createElement( 'div' );
        document.body.appendChild(container);
    
        camera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR );
        camera.position.z = 100;

        scene = new THREE.Scene();
        world = new vphy.World();
        world.start(Date.now()/1000);
        addBox(BOXDEPTH, BOXHEIGHT);
        
        renderer = new THREE.CanvasRenderer();
        renderer.setSize(WINDOWWIDTH, WINDOWHEIGHT);

        container.appendChild(renderer.domElement);
        
        stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				container.appendChild( stats.domElement );
        
        accelStats = document.createElement('div');
        accelStats.style.position = 'absolute';
        accelStats.style.top = '0px';
        accelStats.style.right = '0px';
        $(accelStats).html("<div>X: <span id='xaccel'>0</span></div><div>Y: <span id='yaccel'>0</span></div><div>Z: <span id='zaccel'>0</span></div>");
        container.appendChild(accelStats);
        
        document.addEventListener('mousemove', onDocumentMouseMove, false);
        window.addEventListener('devicemotion', onDeviceMotion, false);
        
        createPaddle(WIDTH, HEIGHT);
        addBall(0xffffff, 0, 0, 0);
		
		// Teh Light!
		var ambientLight = new THREE.AmbientLight( 0xFFFFFF );
		scene.add( ambientLight );
		
		
    }
    
    function addBox(depth, height) {
        //         XROT     YROT    ZROT            X            Y           Z       W       H      COLOR
        addWall(      0,  PI / 2,      0, -height / 2,           0, -depth / 2,  depth, height, roomColors.left); // left
        addWall(      0, -PI / 2,      0,  height / 2,           0, -depth / 2,  depth, height, roomColors.right); // right
        addWall( PI / 2,       0, PI / 2,           0,  height / 2, -depth / 2,  depth, height, roomColors.top); // top
        addWall(-PI / 2,       0, PI / 2,           0, -height / 2, -depth / 2,  depth, height, roomColors.bottom); // bottom        
        addWall(      0,       0,      0,           0,           0,     -depth, height, height, roomColors.back); // back
        
        world.add(new vphy.AABB({
            x : -height / 2,
            y : 0,
            z : -depth / 2,
            width : 1,
            height: height,
            depth : depth
        }));
        world.add(new vphy.AABB({
            x : height / 2,
            y : 0,
            z : -depth / 2,
            width : 1,
            height: height,
            depth : depth
        }));
        world.add(new vphy.AABB({
            x : 0,
            y : -height / 2,
            z : -depth / 2,
            width : height,
            height: 1,
            depth : depth
        }));
        world.add(new vphy.AABB({
            x : 0,
            y : height / 2,
            z : -depth / 2,
            width : height,
            height: 1,
            depth : depth
        }));
        world.add(new vphy.AABB({
            x : 0,
            y : 0,
            z : -depth,
            width : height,
            height: height,
            depth : 1
        }));
    }
    
    function createPaddle(width, height){
        paddle = new vphy.AABB({
            width : width,
            height: height,
            depth : 1
        });
        world.add(paddle);
    }
    
    function addBall(ballColor, x, y, z){
        var geometry, material, mesh;
        geometry = new THREE.SphereGeometry(ballSize);
        material = new THREE.MeshBasicMaterial( { color: ballColor, wireframe: false } );

        mesh = new THREE.Mesh( geometry, material );        
        mesh.position.x = x;
        mesh.position.y = y;
        mesh.position.z = z;
        scene.add( mesh );

        ball  = new vphy.Sphere({
            x : x,
            y : y,
            z : z,
            restitution : 1,
            radius : ballSize,
        });
        ball.setVelocity(2, 10, -50);
        ball.mesh = mesh;
        world.add(ball);
    }
    
    function addWall(xrot, yrot, zrot, x, y, z, width, height, wallcolor) {
        var geometry, material, mesh;
        geometry = new THREE.PlaneGeometry(width, height, 1, 1);
        material = new THREE.MeshBasicMaterial( { color: wallcolor, wireframe: false } );

        mesh = new THREE.Mesh( geometry, material );      
        mesh.rotation.x = xrot;
        mesh.rotation.y = yrot;
        mesh.rotation.z = zrot;
        mesh.position.x = x;
        mesh.position.y = y;
        mesh.position.z = z;
        scene.add( mesh );
    }

    function animate() {
        paddle.x = camera.position.x;
        paddle.y = camera.position.y;
    
        var timeStep = 1/180;
        world.step(timeStep, Date.now()/1000);
        
        ball.mesh.position.x = ball.x;
        ball.mesh.position.y = ball.y;
        ball.mesh.position.z = ball.z;
        

        // Include examples/js/RequestAnimationFrame.js for cross-browser compatibility.
        requestAnimationFrame( animate );
        render();
        stats.update();
    }
    
    function onDeviceMotion(event) {
        var yaccel = (event.accelerationIncludingGravity.x - 9.8); // when held up in landscape, X gets gravity
        var xaccel = (event.accelerationIncludingGravity.y);
        mouseyoffset = Math.round(yaccel * MOTIONFACTOR * 10000) / 10000; 
        mousexoffset = Math.round(xaccel * MOTIONFACTOR * 10000) / 10000;
        $('#xaccel').text(event.accelerationIncludingGravity.x);
        $('#yaccel').text(event.accelerationIncludingGravity.y);
        $('#zaccel').text(event.accelerationIncludingGravity.z);
    }
    
    function onDocumentMouseMove(event) {
        mousex = (event.clientX / WINDOWWIDTH);
        mousey = (event.clientY / WINDOWHEIGHT);
        
        mousexoffset = (mousex - 0.5) * MOVEFACTOR;
        mouseyoffset = (-(mousey - 0.5)) * MOVEFACTOR;

        paddle.x = camera.position.x;
        paddle.y = camera.position.y;
    }

    function render() {        
        var newx = camera.position.x + (mousexoffset * BOXHEIGHT);
        var newy = camera.position.y + (mouseyoffset * BOXHEIGHT);
        
        camera.position.x = Math.max(Math.min(newx, (BOXHEIGHT / 2) - (HEIGHT / 2)), -(BOXHEIGHT / 2) + (HEIGHT / 2));
        camera.position.y = Math.max(Math.min(newy, (BOXHEIGHT / 2) - (HEIGHT / 2)), -(BOXHEIGHT / 2) + (HEIGHT / 2));

        //camera.position.z += 5;
        
        renderer.render( scene, camera );
    }   
    
  </script>

</body>
</html>